<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    <mapper namespace="mapper.RatingMapper">
        
        <insert id="addRating" parameterType="Rating" useGeneratedKeys="true" keyProperty="ratingId">
            INSERT INTO rating 
            ( movie_id, user_id, rating, comment) 
            VALUES 
            ( #{movieId}, #{userId}, #{rating}, #{comment})
        </insert>
        
        <select id="findRatingByMovieIdAndUserId" parameterType="Rating" resultType="Rating">
            SELECT * 
            FROM rating 
            WHERE 
                movie_id = #{movieId} 
                AND user_id = #{userId} 
        </select>
        
        <update id="updateRatingAndComment" parameterType="Rating">
            UPDATE rating 
            SET rating = #{rating}, comment = #{comment} 
            WHERE 
                movie_id = #{movieId} 
                AND user_id = #{userId} 
        </update>
        
        <select id="selectRatingCountListByUserId" parameterType="Rating" resultType="domain.RatingAndGenresCount">
            SELECT rating, COUNT(*) AS count 
            FROM rating 
            WHERE user_id = #{userId}
            GROUP BY rating
        </select>
        
        <select id="selectGenresCountListByUserId" parameterType="Rating" resultType="domain.RatingAndGenresCount">
            SELECT DISTINCT movie_genres.genres_id, genres.name_zh AS genres_name_zh, count(*) AS count
			FROM rating, movie_genres, genres
			WHERE 
			    rating.user_id = #{userId}
			    AND rating.movie_id = movie_genres.movie_id
			    AND movie_genres.genres_id = genres.genres_id
			GROUP BY movie_genres.genres_id
        </select>
    
    </mapper>